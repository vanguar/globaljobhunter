{% extends "layout.html" %}

{% block title %}–†–µ–∑—É–ª—å—Ç–∞—Ç—ã –ø–æ–∏—Å–∫–∞ - GlobalJobHunter{% endblock %}

{% block content %}
<main>
    <section class="results-header">
        <div class="container">
            <h1 class="display-5 fw-bold mb-2">üèÜ –†–µ–∑—É–ª—å—Ç–∞—Ç—ã –ø–æ–∏—Å–∫–∞</h1>
            <p class="lead text-muted">
                –ù–∞–π–¥–µ–Ω–æ {{ stats.total }} –≤–∞–∫–∞–Ω—Å–∏–π –∑–∞ {{ search_time }}—Å.
            </p>
            <a href="{{ url_for('index') }}" class="btn btn-outline-primary mt-3">
                <i class="bi bi-arrow-left me-2"></i>–ò–∑–º–µ–Ω–∏—Ç—å –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –ø–æ–∏—Å–∫–∞
            </a>
        </div>
    </section>
    
    <section class="stats-container">
        <div class="container">
            <div class="row g-4">
                <div class="col-lg-3 col-md-6">
                    <div class="stat-card h-100">
                        <div class="stat-icon" style="color: var(--primary-blue);"><i class="bi bi-briefcase-fill"></i></div>
                        <div class="stat-number">{{ stats.total }}</div>
                        <div class="stat-label">–í—Å–µ–≥–æ –≤–∞–∫–∞–Ω—Å–∏–π</div>
                    </div>
                </div>
                <div class="col-lg-3 col-md-6">
                    <div class="stat-card h-100">
                        <div class="stat-icon" style="color: var(--success);"><i class="bi bi-house-heart-fill"></i></div>
                        <div class="stat-number">{{ stats.refugee_friendly }}</div>
                        <div class="stat-label">–î–ª—è –±–µ–∂–µ–Ω—Ü–µ–≤</div>
                    </div>
                </div>
                <div class="col-lg-3 col-md-6">
                    <div class="stat-card h-100">
                        <div class="stat-icon" style="color: var(--info);"><i class="bi bi-volume-mute-fill"></i></div>
                        <div class="stat-number">{{ stats.no_language }}</div>
                        <div class="stat-label">–ë–µ–∑ –∑–Ω–∞–Ω–∏—è —è–∑—ã–∫–∞</div>
                    </div>
                </div>
                <div class="col-lg-3 col-md-6">
                    <div class="stat-card h-100">
                        <div class="stat-icon" style="color: var(--warning);"><i class="bi bi-cash-coin"></i></div>
                        <div class="stat-number">{{ stats.with_salary }}</div>
                        <div class="stat-label">–° —É–∫–∞–∑–∞–Ω–∏–µ–º –∑–∞—Ä–ø–ª–∞—Ç—ã</div>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <section class="pb-5">
        <div class="container">
            <div class="filter-bar sticky-top mb-4">
                <div class="row g-3 align-items-center">
                    <div class="col-md-6">
                        <div class="input-group">
                             <span class="input-group-text bg-white"><i class="bi bi-search"></i></span>
                             <input type="text" class="form-control" id="job-filter" placeholder="–§–∏–ª—å—Ç—Ä –ø–æ –Ω–∞–∑–≤–∞–Ω–∏—é, –∫–æ–º–ø–∞–Ω–∏–∏..." data-i18n="attr=placeholder">
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="btn-group w-100" role="group">
                            <input type="radio" class="btn-check" name="filter-type" id="all" value="all" checked>
                            <label class="btn btn-outline-primary" for="all"><i class="bi bi-list-ul me-1"></i>–í—Å–µ</label>
                            
                            <input type="radio" class="btn-check" name="filter-type" id="refugees" value="refugees">
                            <label class="btn btn-outline-primary" for="refugees"><i class="bi bi-house-heart me-1"></i>–¢–æ–ª—å–∫–æ –¥–ª—è –±–µ–∂–µ–Ω—Ü–µ–≤</label>
                            
                            <input type="radio" class="btn-check" name="filter-type" id="no-lang" value="no-lang">
                            <label class="btn btn-outline-primary" for="no-lang"><i class="bi bi-volume-mute me-1"></i>–¢–æ–ª—å–∫–æ –±–µ–∑ —è–∑—ã–∫–∞</label>
                        </div>
                    </div>
                </div>
            </div>

            <div id="jobs-container">
                {% if jobs_by_country %}
                    {% for country_name, country_jobs in jobs_by_country.items() %}
                        <!-- –ù–û–í–´–ô –ö–†–ê–°–ò–í–´–ô –†–ê–ó–î–ï–õ–ò–¢–ï–õ–¨ –°–¢–†–ê–ù–´ -->
                        <div class="country-divider" data-country="{{ country_name }}">
                            <div class="country-header">
                                <div class="country-flag">
                                    {% if country_name == '–ì–µ—Ä–º–∞–Ω–∏—è' %}üá©üá™
                                    {% elif country_name == '–ü–æ–ª—å—à–∞' %}üáµüá±
                                    {% elif country_name == '–í–µ–ª–∏–∫–æ–±—Ä–∏—Ç–∞–Ω–∏—è' %}üá¨üáß
                                    {% elif country_name == '–ù–∏–¥–µ—Ä–ª–∞–Ω–¥—ã' %}üá≥üá±
                                    {% elif country_name == '–§—Ä–∞–Ω—Ü–∏—è' %}üá´üá∑
                                    {% elif country_name == '–ê–≤—Å—Ç—Ä–∏—è' %}üá¶üáπ
                                    {% elif country_name == '–°–®–ê' %}üá∫üá∏
                                    {% elif country_name == '–ö–∞–Ω–∞–¥–∞' %}üá®üá¶
                                    {% elif country_name == '–ê–≤—Å—Ç—Ä–∞–ª–∏—è' %}üá¶üá∫
                                    {% elif country_name == '–ò—Ç–∞–ª–∏—è' %}üáÆüáπ
                                    {% elif country_name == '–ò—Å–ø–∞–Ω–∏—è' %}üá™üá∏
                                    {% elif country_name == '–®–≤–µ–π—Ü–∞—Ä–∏—è' %}üá®üá≠
                                    {% elif country_name == '–ë–µ–ª—å–≥–∏—è' %}üáßüá™
                                    {% elif country_name == '–®–≤–µ—Ü–∏—è' %}üá∏üá™
                                    {% elif country_name == '–ù–æ—Ä–≤–µ–≥–∏—è' %}üá≥üá¥
                                    {% elif country_name == '–î–∞–Ω–∏—è' %}üá©üá∞
                                    {% elif country_name == '–ß–µ—Ö–∏—è' %}üá®üáø
                                    {% elif country_name == '–°–ª–æ–≤–∞–∫–∏—è' %}üá∏üá∞
                                    {% else %}üåç{% endif %}
                                </div>
                                <div class="country-info">
                                    <h3 class="country-name">{{ country_name }}</h3>
                                    <p class="country-stats">{{ country_jobs|length }} –≤–∞–∫–∞–Ω—Å–∏–π</p>
                                </div>
                                <div class="country-line"></div>
                            </div>
                        </div>

                        <!-- –í–∞–∫–∞–Ω—Å–∏–∏ —ç—Ç–æ–π —Å—Ç—Ä–∞–Ω—ã -->
                        {% for job in country_jobs %}
                        <div class="job-card" 
                             data-refugee="{{ job.refugee_friendly|lower }}" 
                             data-no-language="{{ (job.language_requirement == 'no_language_required')|lower }}"
                             data-country="{{ country_name }}">
                            <div class="row g-3">
                                <div class="col-lg-8">
                                    <div class="d-flex align-items-start mb-3">
                                        <div>
                                            <h5 class="job-title mb-1">{{ job.title }}</h5>
                                            <p class="company-name mb-2">{{ job.company }}</p>
                                        </div>
                                    </div>
                                    <div class="job-meta mb-3">
                                        <span><i class="bi bi-geo-alt-fill me-2"></i>{{ job.location }}</span>
                                        <span><i class="bi bi-calendar3 me-2"></i>{{ job.posted_date.split('T')[0] }}</span>
                                        <!-- –î–û–ë–ê–í–õ–Ø–ï–ú –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –∏—Å—Ç–æ—á–Ω–∏–∫–∞ -->
                                        <span class="source-badge">
                                            <i class="bi bi-database me-1"></i>{{ job.source }}
                                        </span>
                                    </div>
                                    {% if job.description %}
                                        <p class="job-description">{{ job.description | striptags }}</p>
                                    {% endif %}
                                </div>
                                <div class="col-lg-4 d-flex flex-column justify-content-between align-items-lg-end">
                                    <div class="w-100">
                                        {% if job.refugee_friendly %}
                                            <span class="badge-custom bg-success mb-2"><i class="bi bi-house-heart"></i> –î–ª—è –±–µ–∂–µ–Ω—Ü–µ–≤</span>
                                        {% endif %}
                                        {% if job.language_requirement == 'no_language_required' %}
                                            <span class="badge-custom bg-info mb-2"><i class="bi bi-volume-mute"></i> –ë–µ–∑ —è–∑—ã–∫–∞</span>
                                        {% endif %}

                                        {% if job.salary %}
                                            <div class="salary-badge mt-2">{{ job.salary }}</div>
                                        {% endif %}
                                    </div>
                                    
                                    <div class="mt-3 w-100 d-grid gap-2">
                                         <a href="{{ job.apply_url }}" target="_blank" class="btn btn-primary">
                                            –û—Ç–∫–ª–∏–∫–Ω—É—Ç—å—Å—è <i class="bi bi-box-arrow-up-right ms-2"></i>
                                        </a>
                                         <button type="button" class="btn btn-outline-secondary btn-sm" onclick="copyToClipboard('{{ job.apply_url }}')">
                                            <i class="bi bi-clipboard me-1"></i>–ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å —Å—Å—ã–ª–∫—É
                                         </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                    {% endfor %}
                {% else %}
                    <div class="text-center py-5">
                        <i class="bi bi-binoculars-fill text-muted" style="font-size: 5rem;"></i>
                        <h3 class="mt-4" data-i18n="–ü–æ –≤–∞—à–µ–º—É –∑–∞–ø—Ä–æ—Å—É –Ω–∏—á–µ–≥–æ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ">–ü–æ –≤–∞—à–µ–º—É –∑–∞–ø—Ä–æ—Å—É –Ω–∏—á–µ–≥–æ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ</h3>
                        <p class="text-muted" data-i18n="–ü–æ–ø—Ä–æ–±—É–π—Ç–µ –∏–∑–º–µ–Ω–∏—Ç—å –ø—Ä–æ—Ñ–µ—Å—Å–∏–∏ –∏–ª–∏ —Ä–∞—Å—à–∏—Ä–∏—Ç—å –≥–µ–æ–≥—Ä–∞—Ñ–∏—é –ø–æ–∏—Å–∫–∞.">–ü–æ–ø—Ä–æ–±—É–π—Ç–µ –∏–∑–º–µ–Ω–∏—Ç—å –ø—Ä–æ—Ñ–µ—Å—Å–∏–∏ –∏–ª–∏ —Ä–∞—Å—à–∏—Ä–∏—Ç—å –≥–µ–æ–≥—Ä–∞—Ñ–∏—é –ø–æ–∏—Å–∫–∞.</p>
                    </div>
                {% endif %}
            </div>
        </div>
    </section>

<!-- –ë–õ–û–ö –ü–û–î–î–ï–†–ñ–ö–ò –ü–†–û–ï–ö–¢–ê -->
<section class="support-promo-section py-5">
    <div class="container">
        <div class="row justify-content-center">
            <div class="col-lg-6">
                <div class="support-promo-card text-center" style="background: linear-gradient(135deg, #e3f2fd 0%, #f3e5f5 100%); border-radius: 20px; padding: 40px; border: 2px solid #e1f5fe;">
                    <div style="font-size: 3rem; margin-bottom: 20px;">üíô</div>
                    <h3 style="color: #1976d2; font-weight: 600; margin-bottom: 15px;">–ü–æ–Ω—Ä–∞–≤–∏–ª—Å—è –ø—Ä–æ–µ–∫—Ç?</h3>
                    <p class="text-muted mb-4">–í–∞—à–∞ –ø–æ–¥–¥–µ—Ä–∂–∫–∞ –ø–æ–º–æ–≥–∞–µ—Ç —Å–∞–π—Ç—É —Ä–∞–∑–≤–∏–≤–∞—Ç—å—Å—è. –£–∑–Ω–∞–π—Ç–µ, –∫–∞–∫ –º–æ–∂–Ω–æ –ø–æ–º–æ—á—å –∏ —Å–≤—è–∑–∞—Ç—å—Å—è —Å –∞–≤—Ç–æ—Ä–æ–º.</p>
                    <a href="/support" class="btn btn-primary btn-lg" style="border-radius: 12px; padding: 12px 30px; font-weight: 600;">
                        –ü–µ—Ä–µ–π—Ç–∏ –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü—É –ø–æ–¥–¥–µ—Ä–∂–∫–∏
                    </a>
                </div>
            </div>
        </div>
    </div>
</section>    

    <!-- –î–û–ë–ê–í–ò–¢–¨ –≠–¢–û–¢ –ë–õ–û–ö –ü–ï–†–ï–î –ó–ê–ö–†–´–í–ê–Æ–©–ò–ú </main> -->
<section class="subscription-section py-5 border-top">
    <div class="container">
        <div class="row justify-content-center">
            <div class="col-lg-8">
                <div class="text-center">
                    <h4 class="mb-3">üìß –ü–æ–ª—É—á–∞—Ç—å –Ω–æ–≤—ã–µ –≤–∞–∫–∞–Ω—Å–∏–∏ –Ω–∞ email</h4>
                    <p class="text-muted mb-4">–ï–∂–µ–Ω–µ–¥–µ–ª—å–Ω—ã–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –æ –ø–æ–¥—Ö–æ–¥—è—â–∏—Ö –≤–∞–∫–∞–Ω—Å–∏—è—Ö –Ω–∞ –æ—Å–Ω–æ–≤–µ –≤–∞—à–µ–≥–æ –ø–æ–∏—Å–∫–∞</p>
                    
                    <div class="row justify-content-center">
                        <div class="col-md-8">
                            <div class="input-group input-group-lg">
                                <input type="email" class="form-control" id="subscribe-email" placeholder="–í–∞—à email –¥–ª—è —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π">
                                <button class="btn btn-primary" type="button" onclick="subscribeToEmails()">
                                    <i class="bi bi-envelope me-1"></i>–ü–æ–¥–ø–∏—Å–∞—Ç—å—Å—è
                                </button>
                            </div>
                            <small class="text-muted mt-2 d-block">
                                <i class="bi bi-shield-check me-1"></i>–ë–µ–∑–æ–ø–∞—Å–Ω–æ –∏ –±–µ–∑ —Å–ø–∞–º–∞
                            </small>
                            <small class="text-muted">
                                <a href="javascript:void(0)" onclick="showManageSubscriptionInfo()" class="text-decoration-none">
                                    ‚öôÔ∏è –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø–æ–¥–ø–∏—Å–∫–æ–π
                                </a>
                            </small>
                        </div>
                    </div>
                    
                    <div class="row mt-4">
                        <div class="col-md-4">
                            <div class="feature-item">
                                <i class="bi bi-bell text-primary mb-2 d-block" style="font-size: 1.5rem;"></i>
                                <small class="text-muted">–ù–æ–≤—ã–µ –≤–∞–∫–∞–Ω—Å–∏–∏ –ø–µ—Ä–≤—ã–º–∏</small>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="feature-item">
                                <i class="bi bi-gear text-primary mb-2 d-block" style="font-size: 1.5rem;"></i>
                                <small class="text-muted">–ì–∏–±–∫–∏–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏</small>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="feature-item">
                                <i class="bi bi-x-circle text-primary mb-2 d-block" style="font-size: 1.5rem;"></i>
                                <small class="text-muted">–õ–µ–≥–∫–∞—è –æ—Ç–ø–∏—Å–∫–∞</small>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</section>

</main>
{% endblock %}

{% block scripts %}
<script defer src="{{ url_for('static', filename='js/localization.js') }}"></script>
<script>
document.getElementById('job-filter').addEventListener('input', filterJobs);
document.querySelectorAll('input[name="filter-type"]').forEach(radio => {
    radio.addEventListener('change', filterJobs);
});

function filterJobs() {
    const searchTerm = document.getElementById('job-filter').value.toLowerCase();
    const filterType = document.querySelector('input[name="filter-type"]:checked').value;
    const jobCards = document.querySelectorAll('.job-card');
    const countryDividers = document.querySelectorAll('.country-divider');
    
    let visibleCount = 0;
    const visibleCountries = new Set();
    
    jobCards.forEach(card => {
        const title = card.querySelector('.job-title').textContent.toLowerCase();
        const company = card.querySelector('.company-name').textContent.toLowerCase();
        const country = card.dataset.country;
        const matchesSearch = title.includes(searchTerm) || company.includes(searchTerm);
        
        let matchesFilter = true;
        if (filterType === 'refugees') {
            matchesFilter = card.dataset.refugee === 'true';
        } else if (filterType === 'no-lang') {
            matchesFilter = card.dataset.noLanguage === 'true';
        }
        
        if (matchesSearch && matchesFilter) {
           card.style.display = 'block';
           visibleCount++;
           visibleCountries.add(country);
       } else {
           card.style.display = 'none';
       }
   });
   
   // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º/—Å–∫—Ä—ã–≤–∞–µ–º —Ä–∞–∑–¥–µ–ª–∏—Ç–µ–ª–∏ —Å—Ç—Ä–∞–Ω
   countryDividers.forEach(divider => {
       const country = divider.dataset.country;
       if (visibleCountries.has(country)) {
           divider.style.display = 'block';
       } else {
           divider.style.display = 'none';
       }
   });
   
   updateResultsCount(visibleCount, jobCards.length);
}

function updateResultsCount(count, total) {
   let counterElement = document.getElementById('results-counter');
   const jobsContainer = document.getElementById('jobs-container');
   
   if (!counterElement) {
       counterElement = document.createElement('div');
       counterElement.id = 'results-counter';
       jobsContainer.insertBefore(counterElement, jobsContainer.firstChild);
   }
   
   if (count === total) {
       if (counterElement) counterElement.remove();
       return;
   }
   
   counterElement.className = 'alert alert-info mt-3';
   counterElement.innerHTML = `<i class="bi bi-info-circle me-2"></i>–ü–æ–∫–∞–∑–∞–Ω–æ –æ—Ç—Ñ–∏–ª—å—Ç—Ä–æ–≤–∞–Ω–Ω—ã—Ö –≤–∞–∫–∞–Ω—Å–∏–π: <strong>${count} –∏–∑ ${total}</strong>`;
   
   if (count === 0) {
       counterElement.className = 'alert alert-warning mt-3';
       counterElement.innerHTML = `<i class="bi bi-exclamation-triangle me-2"></i>–ù–µ—Ç –≤–∞–∫–∞–Ω—Å–∏–π, —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–∏—Ö —Ñ–∏–ª—å—Ç—Ä–∞–º`;
   }
}

function copyToClipboard(text) {
   navigator.clipboard.writeText(text).then(() => {
       showToast('‚úÖ –°—Å—ã–ª–∫–∞ —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∞!', 'success');
   }).catch(() => {
       showToast('‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å —Å–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å', 'danger');
   });
}

function showToast(message, type = 'info') {
   const toastContainer = document.getElementById('toast-container') || createToastContainer();
   const toast = document.createElement('div');
   toast.className = `alert alert-${type} alert-dismissible fade show m-0`;
   toast.setAttribute('role', 'alert');
   toast.style.minWidth = '250px';
   toast.innerHTML = `${message}<button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>`;
   
   toastContainer.appendChild(toast);
   
   const bsAlert = new bootstrap.Alert(toast);
   setTimeout(() => bsAlert.close(), 3000);
}

function createToastContainer() {
    const container = document.createElement('div');
    container.id = 'toast-container';
    container.style.cssText = 'position: fixed; top: 20px; right: 20px; z-index: 1056;';
    document.body.appendChild(container);
    return container;
}

function subscribeToEmails() {
    const emailInput = document.getElementById('subscribe-email');
    const email = emailInput.value.trim();
    
    if (!email || !email.includes('@')) {
        showToast('‚ùå –í–≤–µ–¥–∏—Ç–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π email –∞–¥—Ä–µ—Å', 'warning');
        return;
    }
    
    fetch('/subscribe', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ email: email })
    })
    .then(response => {
        if (response.status === 409) {
            return response.json().then(data => {
                showSubscriptionChoiceModal(email, data);
                throw new Error('HANDLED_409');
            });
        } else if (response.ok) {
            return response.json();
        } else {
            return response.json().then(data => {
                throw new Error(data.error || '–û—à–∏–±–∫–∞ –ø–æ–¥–ø–∏—Å–∫–∏');
            });
        }
    })
    .then(data => {
        showToast('‚úÖ ' + data.message, 'success');
        emailInput.value = '';
    })
    .catch(error => {
        if (error.message === 'HANDLED_409') {
            return;
        }
        console.error('–û—à–∏–±–∫–∞ –ø–æ–¥–ø–∏—Å–∫–∏:', error);
        showToast('‚ùå ' + error.message, 'danger');
    });
}

function showManageSubscriptionInfo() {
    alert('üìß –°—Å—ã–ª–∫–∞ –Ω–∞ —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø–æ–¥–ø–∏—Å–∫–æ–π –±—É–¥–µ—Ç –≤ –∫–∞–∂–¥–æ–º email —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–∏!\n\n–í—ã —Å–º–æ–∂–µ—Ç–µ:\n‚Ä¢ –ò–∑–º–µ–Ω–∏—Ç—å –ø—Ä–æ—Ñ–µ—Å—Å–∏–∏\n‚Ä¢ –ò–∑–º–µ–Ω–∏—Ç—å —Å—Ç—Ä–∞–Ω—ã\n‚Ä¢ –ò–∑–º–µ–Ω–∏—Ç—å —á–∞—Å—Ç–æ—Ç—É —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π\n‚Ä¢ –û—Ç–ø–∏—Å–∞—Ç—å—Å—è');
}

function checkSystemStatus() {
    fetch('/health')
        .then(response => {
            if (response.ok) {
                return response.text();
            }
            throw new Error('–°–µ—Ä–≤–∏—Å –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω');
        })
        .then(html => {
            // –°–æ–∑–¥–∞–µ–º –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ —Å —Å–æ–¥–µ—Ä–∂–∏–º—ã–º —Å—Ç–∞—Ç—É—Å–∞
            const modal = document.createElement('div');
            modal.className = 'modal fade';
            modal.id = 'status-modal';
            modal.innerHTML = `
                <div class="modal-dialog modal-lg">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title">–°—Ç–∞—Ç—É—Å —Å–∏—Å—Ç–µ–º—ã</h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                        </div>
                        <div class="modal-body">
                            <iframe srcdoc="${html.replace(/"/g, '&quot;')}" style="width: 100%; height: 400px; border: none;"></iframe>
                        </div>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
            
            const bootstrapModal = new bootstrap.Modal(modal);
            bootstrapModal.show();
            
            // –£–¥–∞–ª—è–µ–º –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –ø–æ—Å–ª–µ –∑–∞–∫—Ä—ã—Ç–∏—è
            modal.addEventListener('hidden.bs.modal', () => {
                modal.remove();
            });
        })
        .catch(error => {
            alert('‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å—Ç–∞—Ç—É—Å–∞: ' + error.message);
        });
        }

function showSubscriptionChoiceModal(email, data) {
    if (!data || !data.current_subscription || !data.new_subscription) {
        showToast('‚ùå –û—à–∏–±–∫–∞ –¥–∞–Ω–Ω—ã—Ö –ø–æ–¥–ø–∏—Å–∫–∏', 'danger');
        return;
    }
    
    const modal = document.createElement('div');
    modal.className = 'modal fade';
    modal.id = 'subscription-choice-modal';
    
    const currentJobs = data.current_subscription.jobs.slice(0, 3).join(', ') + 
                       (data.current_subscription.jobs.length > 3 ? ` (+${data.current_subscription.jobs.length - 3})` : '');
    const newJobs = data.new_subscription.jobs.slice(0, 3).join(', ') + 
                   (data.new_subscription.jobs.length > 3 ? ` (+${data.new_subscription.jobs.length - 3})` : '');
    
    modal.innerHTML = `
        <div class="modal-dialog modal-lg">
            <div class="modal-content" style="border: none; border-radius: 20px; box-shadow: 0 20px 60px rgba(0,0,0,0.2);">
                <div class="modal-header" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; border-radius: 20px 20px 0 0; padding: 25px;">
                    <div class="d-flex align-items-center">
                        <div class="me-3" style="background: rgba(255,255,255,0.2); border-radius: 50%; width: 50px; height: 50px; display: flex; align-items: center; justify-content: center;">
                            <i class="bi bi-envelope-heart" style="font-size: 1.5rem;"></i>
                        </div>
                        <div>
                            <h4 class="modal-title mb-1" style="font-weight: 600;">–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø–æ–¥–ø–∏—Å–∫–æ–π</h4>
                            <small style="opacity: 0.9;">–ù–∞—Å—Ç—Ä–æ–π—Ç–µ –≤–∞—à–∏ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è</small>
                        </div>
                    </div>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" style="filter: brightness(0) invert(1);"></button>
                </div>
                
                <div class="modal-body" style="padding: 30px;">
                    <div class="alert alert-info" style="border: none; background: linear-gradient(45deg, #e3f2fd, #f3e5f5); border-radius: 15px; border-left: 4px solid #2196F3;">
                        <i class="bi bi-info-circle me-2"></i>
                        <strong>–£ –≤–∞—Å —É–∂–µ –µ—Å—Ç—å –ø–æ–¥–ø–∏—Å–∫–∞ –Ω–∞ —ç—Ç–æ—Ç email!</strong>
                        <br><small class="text-muted">–í—ã–±–µ—Ä–∏—Ç–µ, –∫–∞–∫ –ø–æ—Å—Ç—É–ø–∏—Ç—å —Å –Ω–æ–≤—ã–º–∏ –ø–∞—Ä–∞–º–µ—Ç—Ä–∞–º–∏ –ø–æ–∏—Å–∫–∞</small>
                    </div>
                    
                    <div class="row g-4 mt-2">
                        <div class="col-md-6">
                            <div class="subscription-card current" style="background: linear-gradient(135deg, #f8f9ff 0%, #e8f4fd 100%); border: 2px solid #e3f2fd; border-radius: 15px; padding: 20px; height: 100%; position: relative;">
                                <div class="d-flex align-items-center mb-3">
                                    <div class="subscription-icon" style="background: #2196F3; color: white; border-radius: 10px; width: 40px; height: 40px; display: flex; align-items: center; justify-content: center; margin-right: 15px;">
                                        <i class="bi bi-bookmark-check"></i>
                                    </div>
                                    <div>
                                        <h6 class="mb-0" style="color: #2196F3; font-weight: 600;">–¢–µ–∫—É—â–∞—è –ø–æ–¥–ø–∏—Å–∫–∞</h6>
                                        <small class="text-muted">–î–µ–π—Å—Ç–≤—É—é—â–∏–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏</small>
                                    </div>
                                </div>
                                <div class="subscription-details">
                                    <div class="detail-item mb-2">
                                        <i class="bi bi-briefcase text-primary me-2"></i>
                                        <small><strong>–ü—Ä–æ—Ñ–µ—Å—Å–∏–∏:</strong></small>
                                        <div class="ms-4"><small class="text-muted">${currentJobs}</small></div>
                                    </div>
                                    <div class="detail-item mb-2">
                                        <i class="bi bi-globe text-primary me-2"></i>
                                        <small><strong>–°—Ç—Ä–∞–Ω—ã:</strong></small>
                                        <div class="ms-4"><small class="text-muted">${data.current_subscription.countries.join(', ')}</small></div>
                                    </div>
                                    <div class="detail-item">
                                        <i class="bi bi-geo-alt text-primary me-2"></i>
                                        <small><strong>–ì–æ—Ä–æ–¥:</strong></small>
                                        <div class="ms-4"><small class="text-muted">${data.current_subscription.city || '–ù–µ —É–∫–∞–∑–∞–Ω'}</small></div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="col-md-6">
                            <div class="subscription-card new" style="background: linear-gradient(135deg, #f0fff4 0%, #e8f5e8 100%); border: 2px solid #e8f5e8; border-radius: 15px; padding: 20px; height: 100%; position: relative;">
                                <div class="d-flex align-items-center mb-3">
                                    <div class="subscription-icon" style="background: #4CAF50; color: white; border-radius: 10px; width: 40px; height: 40px; display: flex; align-items: center; justify-content: center; margin-right: 15px;">
                                        <i class="bi bi-bookmark-plus"></i>
                                    </div>
                                    <div>
                                        <h6 class="mb-0" style="color: #4CAF50; font-weight: 600;">–ù–æ–≤–∞—è –ø–æ–¥–ø–∏—Å–∫–∞</h6>
                                        <small class="text-muted">–ü–∞—Ä–∞–º–µ—Ç—Ä—ã –∏–∑ –ø–æ–∏—Å–∫–∞</small>
                                    </div>
                                </div>
                                <div class="subscription-details">
                                    <div class="detail-item mb-2">
                                        <i class="bi bi-briefcase text-success me-2"></i>
                                        <small><strong>–ü—Ä–æ—Ñ–µ—Å—Å–∏–∏:</strong></small>
                                        <div class="ms-4"><small class="text-muted">${newJobs}</small></div>
                                    </div>
                                    <div class="detail-item mb-2">
                                        <i class="bi bi-globe text-success me-2"></i>
                                        <small><strong>–°—Ç—Ä–∞–Ω—ã:</strong></small>
                                        <div class="ms-4"><small class="text-muted">${data.new_subscription.countries.join(', ')}</small></div>
                                    </div>
                                    <div class="detail-item">
                                        <i class="bi bi-geo-alt text-success me-2"></i>
                                        <small><strong>–ì–æ—Ä–æ–¥:</strong></small>
                                        <div class="ms-4"><small class="text-muted">${data.new_subscription.city || '–ù–µ —É–∫–∞–∑–∞–Ω'}</small></div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="text-center mt-4">
                        <h6 class="mb-3" style="color: #666;">–í—ã–±–µ—Ä–∏—Ç–µ –¥–µ–π—Å—Ç–≤–∏–µ:</h6>
                    </div>
                </div>
                
                <div class="modal-footer" style="border: none; padding: 20px 30px 30px; gap: 15px;">
                    <button type="button" class="btn btn-outline-secondary flex-fill" data-bs-dismiss="modal" style="border-radius: 12px; padding: 12px; font-weight: 500;">
                        <i class="bi bi-x-circle me-2"></i>–û—Ç–º–µ–Ω–∞
                    </button>
                    <button type="button" class="btn btn-warning flex-fill" onclick="updateSubscription('${email}', 'replace')" style="border-radius: 12px; padding: 12px; font-weight: 600; box-shadow: 0 4px 15px rgba(255, 193, 7, 0.3);">
                        <i class="bi bi-arrow-repeat me-2"></i>–ó–∞–º–µ–Ω–∏—Ç—å –ø–æ–¥–ø–∏—Å–∫—É
                    </button>
                    <button type="button" class="btn btn-success flex-fill" onclick="updateSubscription('${email}', 'merge')" style="border-radius: 12px; padding: 12px; font-weight: 600; box-shadow: 0 4px 15px rgba(76, 175, 80, 0.3);">
                        <i class="bi bi-plus-circle me-2"></i>–û–±—ä–µ–¥–∏–Ω–∏—Ç—å –ø–æ–¥–ø–∏—Å–∫–∏
                    </button>
                </div>
            </div>
        </div>
    `;
    
    document.body.appendChild(modal);
    const bootstrapModal = new bootstrap.Modal(modal);
    bootstrapModal.show();
    
    modal.addEventListener('hidden.bs.modal', () => modal.remove());
}

function updateSubscription(email, action) {
    fetch('/subscribe/update', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ email: email, action: action })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showToast('‚úÖ ' + data.message, 'success');
            const modal = bootstrap.Modal.getInstance(document.getElementById('subscription-choice-modal'));
            if (modal) modal.hide();
            const emailInput = document.getElementById('subscribe-email');
            if (emailInput) emailInput.value = '';
        } else {
            showToast('‚ùå ' + data.error, 'warning');
        }
    })
    .catch(error => {
        console.error('–û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –ø–æ–¥–ø–∏—Å–∫–∏:', error);
        showToast('‚ùå –û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –ø–æ–¥–ø–∏—Å–∫–∏', 'danger');
    });
}        

</script>
{% endblock %}